revoke delete on table "public"."appointments" from "anon";

revoke insert on table "public"."appointments" from "anon";

revoke references on table "public"."appointments" from "anon";

revoke select on table "public"."appointments" from "anon";

revoke trigger on table "public"."appointments" from "anon";

revoke truncate on table "public"."appointments" from "anon";

revoke update on table "public"."appointments" from "anon";

revoke delete on table "public"."appointments" from "authenticated";

revoke insert on table "public"."appointments" from "authenticated";

revoke references on table "public"."appointments" from "authenticated";

revoke select on table "public"."appointments" from "authenticated";

revoke trigger on table "public"."appointments" from "authenticated";

revoke truncate on table "public"."appointments" from "authenticated";

revoke update on table "public"."appointments" from "authenticated";

revoke delete on table "public"."appointments" from "service_role";

revoke insert on table "public"."appointments" from "service_role";

revoke references on table "public"."appointments" from "service_role";

revoke select on table "public"."appointments" from "service_role";

revoke trigger on table "public"."appointments" from "service_role";

revoke truncate on table "public"."appointments" from "service_role";

revoke update on table "public"."appointments" from "service_role";

revoke delete on table "public"."clients" from "anon";

revoke insert on table "public"."clients" from "anon";

revoke references on table "public"."clients" from "anon";

revoke select on table "public"."clients" from "anon";

revoke trigger on table "public"."clients" from "anon";

revoke truncate on table "public"."clients" from "anon";

revoke update on table "public"."clients" from "anon";

revoke delete on table "public"."clients" from "authenticated";

revoke insert on table "public"."clients" from "authenticated";

revoke references on table "public"."clients" from "authenticated";

revoke select on table "public"."clients" from "authenticated";

revoke trigger on table "public"."clients" from "authenticated";

revoke truncate on table "public"."clients" from "authenticated";

revoke update on table "public"."clients" from "authenticated";

revoke delete on table "public"."clients" from "service_role";

revoke insert on table "public"."clients" from "service_role";

revoke references on table "public"."clients" from "service_role";

revoke select on table "public"."clients" from "service_role";

revoke trigger on table "public"."clients" from "service_role";

revoke truncate on table "public"."clients" from "service_role";

revoke update on table "public"."clients" from "service_role";

revoke delete on table "public"."invoice_items" from "anon";

revoke insert on table "public"."invoice_items" from "anon";

revoke references on table "public"."invoice_items" from "anon";

revoke select on table "public"."invoice_items" from "anon";

revoke trigger on table "public"."invoice_items" from "anon";

revoke truncate on table "public"."invoice_items" from "anon";

revoke update on table "public"."invoice_items" from "anon";

revoke delete on table "public"."invoice_items" from "authenticated";

revoke insert on table "public"."invoice_items" from "authenticated";

revoke references on table "public"."invoice_items" from "authenticated";

revoke select on table "public"."invoice_items" from "authenticated";

revoke trigger on table "public"."invoice_items" from "authenticated";

revoke truncate on table "public"."invoice_items" from "authenticated";

revoke update on table "public"."invoice_items" from "authenticated";

revoke delete on table "public"."invoice_items" from "service_role";

revoke insert on table "public"."invoice_items" from "service_role";

revoke references on table "public"."invoice_items" from "service_role";

revoke select on table "public"."invoice_items" from "service_role";

revoke trigger on table "public"."invoice_items" from "service_role";

revoke truncate on table "public"."invoice_items" from "service_role";

revoke update on table "public"."invoice_items" from "service_role";

revoke delete on table "public"."invoices" from "anon";

revoke insert on table "public"."invoices" from "anon";

revoke references on table "public"."invoices" from "anon";

revoke select on table "public"."invoices" from "anon";

revoke trigger on table "public"."invoices" from "anon";

revoke truncate on table "public"."invoices" from "anon";

revoke update on table "public"."invoices" from "anon";

revoke delete on table "public"."invoices" from "authenticated";

revoke insert on table "public"."invoices" from "authenticated";

revoke references on table "public"."invoices" from "authenticated";

revoke select on table "public"."invoices" from "authenticated";

revoke trigger on table "public"."invoices" from "authenticated";

revoke truncate on table "public"."invoices" from "authenticated";

revoke update on table "public"."invoices" from "authenticated";

revoke delete on table "public"."invoices" from "service_role";

revoke insert on table "public"."invoices" from "service_role";

revoke references on table "public"."invoices" from "service_role";

revoke select on table "public"."invoices" from "service_role";

revoke trigger on table "public"."invoices" from "service_role";

revoke truncate on table "public"."invoices" from "service_role";

revoke update on table "public"."invoices" from "service_role";

revoke delete on table "public"."pets" from "anon";

revoke insert on table "public"."pets" from "anon";

revoke references on table "public"."pets" from "anon";

revoke select on table "public"."pets" from "anon";

revoke trigger on table "public"."pets" from "anon";

revoke truncate on table "public"."pets" from "anon";

revoke update on table "public"."pets" from "anon";

revoke delete on table "public"."pets" from "authenticated";

revoke insert on table "public"."pets" from "authenticated";

revoke references on table "public"."pets" from "authenticated";

revoke select on table "public"."pets" from "authenticated";

revoke trigger on table "public"."pets" from "authenticated";

revoke truncate on table "public"."pets" from "authenticated";

revoke update on table "public"."pets" from "authenticated";

revoke delete on table "public"."pets" from "service_role";

revoke insert on table "public"."pets" from "service_role";

revoke references on table "public"."pets" from "service_role";

revoke select on table "public"."pets" from "service_role";

revoke trigger on table "public"."pets" from "service_role";

revoke truncate on table "public"."pets" from "service_role";

revoke update on table "public"."pets" from "service_role";

revoke delete on table "public"."products" from "anon";

revoke insert on table "public"."products" from "anon";

revoke references on table "public"."products" from "anon";

revoke select on table "public"."products" from "anon";

revoke trigger on table "public"."products" from "anon";

revoke truncate on table "public"."products" from "anon";

revoke update on table "public"."products" from "anon";

revoke delete on table "public"."products" from "authenticated";

revoke insert on table "public"."products" from "authenticated";

revoke references on table "public"."products" from "authenticated";

revoke select on table "public"."products" from "authenticated";

revoke trigger on table "public"."products" from "authenticated";

revoke truncate on table "public"."products" from "authenticated";

revoke update on table "public"."products" from "authenticated";

revoke delete on table "public"."products" from "service_role";

revoke insert on table "public"."products" from "service_role";

revoke references on table "public"."products" from "service_role";

revoke select on table "public"."products" from "service_role";

revoke trigger on table "public"."products" from "service_role";

revoke truncate on table "public"."products" from "service_role";

revoke update on table "public"."products" from "service_role";

revoke delete on table "public"."profiles" from "anon";

revoke insert on table "public"."profiles" from "anon";

revoke references on table "public"."profiles" from "anon";

revoke select on table "public"."profiles" from "anon";

revoke trigger on table "public"."profiles" from "anon";

revoke truncate on table "public"."profiles" from "anon";

revoke update on table "public"."profiles" from "anon";

revoke delete on table "public"."profiles" from "authenticated";

revoke insert on table "public"."profiles" from "authenticated";

revoke references on table "public"."profiles" from "authenticated";

revoke select on table "public"."profiles" from "authenticated";

revoke trigger on table "public"."profiles" from "authenticated";

revoke truncate on table "public"."profiles" from "authenticated";

revoke update on table "public"."profiles" from "authenticated";

revoke delete on table "public"."profiles" from "service_role";

revoke insert on table "public"."profiles" from "service_role";

revoke references on table "public"."profiles" from "service_role";

revoke select on table "public"."profiles" from "service_role";

revoke trigger on table "public"."profiles" from "service_role";

revoke truncate on table "public"."profiles" from "service_role";

revoke update on table "public"."profiles" from "service_role";

revoke delete on table "public"."sale_items" from "anon";

revoke insert on table "public"."sale_items" from "anon";

revoke references on table "public"."sale_items" from "anon";

revoke select on table "public"."sale_items" from "anon";

revoke trigger on table "public"."sale_items" from "anon";

revoke truncate on table "public"."sale_items" from "anon";

revoke update on table "public"."sale_items" from "anon";

revoke delete on table "public"."sale_items" from "authenticated";

revoke insert on table "public"."sale_items" from "authenticated";

revoke references on table "public"."sale_items" from "authenticated";

revoke select on table "public"."sale_items" from "authenticated";

revoke trigger on table "public"."sale_items" from "authenticated";

revoke truncate on table "public"."sale_items" from "authenticated";

revoke update on table "public"."sale_items" from "authenticated";

revoke delete on table "public"."sale_items" from "service_role";

revoke insert on table "public"."sale_items" from "service_role";

revoke references on table "public"."sale_items" from "service_role";

revoke select on table "public"."sale_items" from "service_role";

revoke trigger on table "public"."sale_items" from "service_role";

revoke truncate on table "public"."sale_items" from "service_role";

revoke update on table "public"."sale_items" from "service_role";

revoke delete on table "public"."sales" from "anon";

revoke insert on table "public"."sales" from "anon";

revoke references on table "public"."sales" from "anon";

revoke select on table "public"."sales" from "anon";

revoke trigger on table "public"."sales" from "anon";

revoke truncate on table "public"."sales" from "anon";

revoke update on table "public"."sales" from "anon";

revoke delete on table "public"."sales" from "authenticated";

revoke insert on table "public"."sales" from "authenticated";

revoke references on table "public"."sales" from "authenticated";

revoke select on table "public"."sales" from "authenticated";

revoke trigger on table "public"."sales" from "authenticated";

revoke truncate on table "public"."sales" from "authenticated";

revoke update on table "public"."sales" from "authenticated";

revoke delete on table "public"."sales" from "service_role";

revoke insert on table "public"."sales" from "service_role";

revoke references on table "public"."sales" from "service_role";

revoke select on table "public"."sales" from "service_role";

revoke trigger on table "public"."sales" from "service_role";

revoke truncate on table "public"."sales" from "service_role";

revoke update on table "public"."sales" from "service_role";

revoke delete on table "public"."services" from "anon";

revoke insert on table "public"."services" from "anon";

revoke references on table "public"."services" from "anon";

revoke select on table "public"."services" from "anon";

revoke trigger on table "public"."services" from "anon";

revoke truncate on table "public"."services" from "anon";

revoke update on table "public"."services" from "anon";

revoke delete on table "public"."services" from "authenticated";

revoke insert on table "public"."services" from "authenticated";

revoke references on table "public"."services" from "authenticated";

revoke select on table "public"."services" from "authenticated";

revoke trigger on table "public"."services" from "authenticated";

revoke truncate on table "public"."services" from "authenticated";

revoke update on table "public"."services" from "authenticated";

revoke delete on table "public"."services" from "service_role";

revoke insert on table "public"."services" from "service_role";

revoke references on table "public"."services" from "service_role";

revoke select on table "public"."services" from "service_role";

revoke trigger on table "public"."services" from "service_role";

revoke truncate on table "public"."services" from "service_role";

revoke update on table "public"."services" from "service_role";

set check_function_bodies = off;

CREATE OR REPLACE FUNCTION public.calculate_sale_totals()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    -- Calculate subtotal from sale items
    NEW.subtotal := (
        SELECT COALESCE(SUM(price * quantity), 0)
        FROM sale_items
        WHERE sale_id = NEW.id
    );
    
    -- Ensure discount and surcharge are not null
    NEW.discount_amount := COALESCE(NEW.discount_amount, 0);
    NEW.surcharge_amount := COALESCE(NEW.surcharge_amount, 0);
    
    -- Calculate final total
    NEW.total := NEW.subtotal - NEW.discount_amount + NEW.surcharge_amount;
    
    RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.enforce_free_appointments_limit()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
declare
  v_plan  text;
  v_limit int := (free_limits()->>'appointments_per_month')::int;
  v_count int;
  v_user  uuid := coalesce(new.user_id, old.user_id);
  v_date  date := coalesce(new.date, old.date);
  v_month_start date := date_trunc('month', v_date)::date;
  v_month_end   date := (date_trunc('month', v_date) + interval '1 month - 1 day')::date;
begin
  v_plan := public.get_user_plan(v_user);

  if v_plan = 'free' then
    select count(*) into v_count
    from public.appointments a
    where a.user_id = v_user
      and a.date between v_month_start and v_month_end
      and (tg_op <> 'UPDATE' or a.id <> new.id);

    if v_count >= v_limit then
      raise exception 'Limite do plano Free atingido: máximo % agendamentos no mês.', v_limit
        using hint   = 'Atualize para o Pro para criar mais agendamentos este mês.',
              errcode = 'P0001';
    end if;
  end if;

  return new;
end;
$function$
;

CREATE OR REPLACE FUNCTION public.enforce_free_pets_limit()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
declare
  v_plan  text;
  v_limit int := (free_limits()->>'pets')::int;
  v_count int;
  v_user  uuid := coalesce(new.user_id, old.user_id);
begin
  v_plan := public.get_user_plan(v_user);

  if v_plan = 'free' then
    select count(*) into v_count
    from public.pets
    where user_id = v_user
      and (tg_op <> 'UPDATE' or id <> new.id);

    if v_count >= v_limit then
      raise exception 'Limite do plano Free atingido: máximo % pets.', v_limit
        using hint   = 'Atualize para o Pro para cadastrar mais pets.',
              errcode = 'P0001';
    end if;
  end if;

  return new;
end;
$function$
;

CREATE OR REPLACE FUNCTION public.enforce_free_products_limit()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
declare
  v_plan  text;
  v_limit int := (free_limits()->>'products')::int;
  v_count int;
  v_user  uuid := coalesce(new.user_id, old.user_id);
begin
  v_plan := public.get_user_plan(v_user);

  if v_plan = 'free' then
    select count(*) into v_count
    from public.products
    where user_id = v_user
      and (tg_op <> 'UPDATE' or id <> new.id);

    if v_count >= v_limit then
      raise exception 'Limite do plano Free atingido: máximo % produtos no estoque.', v_limit
        using hint   = 'Atualize para o Pro para cadastrar mais produtos.',
              errcode = 'P0001';
    end if;
  end if;

  return new;
end;
$function$
;

CREATE OR REPLACE FUNCTION public.enforce_free_services_limit()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
declare
  v_plan  text;
  v_limit int := (free_limits()->>'services')::int;
  v_count int;
  v_user  uuid := coalesce(new.user_id, old.user_id);
begin
  v_plan := public.get_user_plan(v_user);

  if v_plan = 'free' then
    select count(*) into v_count
    from public.services
    where user_id = v_user
      and (tg_op <> 'UPDATE' or id <> new.id);

    if v_count >= v_limit then
      raise exception 'Limite do plano Free atingido: máximo % serviços.', v_limit
        using hint   = 'Atualize para o Pro para cadastrar mais serviços.',
              errcode = 'P0001';
    end if;
  end if;

  return new;
end;
$function$
;

CREATE OR REPLACE FUNCTION public.free_limits()
 RETURNS jsonb
 LANGUAGE sql
 STABLE
AS $function$
  select jsonb_build_object(
    'pets', 10,
    'appointments_per_month', 15,
    'products', 20,
    'services', 5
  )
$function$
;

CREATE OR REPLACE FUNCTION public.get_user_plan(p_user uuid)
 RETURNS text
 LANGUAGE sql
 STABLE
AS $function$
  select coalesce(plan, 'free') from public.profiles where id = p_user
$function$
;

CREATE OR REPLACE FUNCTION public.handle_new_user()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  INSERT INTO public.profiles (id, name, role, trial_end_date)
  VALUES (
    NEW.id,
    COALESCE(NEW.raw_user_meta_data->>'name', NEW.email),
    'admin',
    (NOW() + INTERVAL '7 days')
  );
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_timestamp()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_updated_at_column()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$function$
;



